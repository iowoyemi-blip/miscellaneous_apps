
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Target Score Challenge — Square Roots Operations (Packet)</title>
<style>
  :root{ --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#7c3aed; --good:#16a34a; --bad:#dc2626; --warn:#f59e0b; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,#0b1226,#0e1630 40%,#0d1b2a);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:auto;padding:24px}
  .card{background:rgba(17,24,39,.85);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:24px;box-shadow:0 10px 25px rgba(0,0,0,.35)}
  h1{font-size:clamp(24px,3.2vw,34px);margin:0 0 8px}
  .sub{color:var(--muted);margin:0 0 18px}
  .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
  input{background:#0b1020;color:var(--ink);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px;font-size:16px;outline:none}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 18px;font-weight:700;letter-spacing:.3px}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--ink)}
  .hud{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 10px;flex-wrap:wrap}
  .pill{font-weight:800;padding:6px 10px;border-radius:999px;background:#0b1020;border:1px solid rgba(255,255,255,.12);color:var(--muted)}
  .timer{height:10px;background:#0a1022;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
  .bar{height:100%;width:100%;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444);transition:width .2s linear}
  .math{font-size:clamp(18px,2.6vw,28px);font-weight:800;text-align:center;margin:12px 0}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:12px;margin-top:10px}
  .choice{display:flex;align-items:center;justify-content:center;text-align:center;background:#0c1328;border:1px solid rgba(255,255,255,.08);color:var(--ink);border-radius:14px;min-height:72px;padding:12px;font-weight:700;cursor:pointer;transition:.15s transform,.15s box-shadow,.15s background}
  .choice:hover{transform:translateY(-2px);box-shadow:0 10px 15px rgba(0,0,0,.25)}
  .choice.correct{background:rgba(22,163,74,.18);border-color:rgba(22,163,74,.45)}
  .choice.wrong{background:rgba(220,38,38,.18);border-color:rgba(220,38,38,.45)}
  .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  sup{font-size:.6em}
  .note{font-size:13px;color:var(--muted);margin-top:10px}
  .target{font-weight:900}
</style>
</head>
<body>
<div class="wrap">
  <div id="screen-start" class="card">
    <h1>Target Score Challenge — Square Roots Operations</h1>
    <p class="sub">Goal: reach <span class="target">5,000 pts</span> in <b>5:00</b>. Uses every problem from your uploaded packet.</p>
    <div class="row">
      <label>Player name
        <input id="player" placeholder="e.g., Jordan A." autocomplete="off">
      </label>
      <div class="pill">Settings locked</div>
    </div>
    <div class="note">Scoring: Correct = 200 pts + time bonus (up to 300) + streak bonus (＋50 per streak, max ＋300). Wrong = no points, streak resets.</div>
    <div style="margin-top:18px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn primary" id="start">Start Challenge</button>
    </div>
  </div>

  <div id="screen-game" class="card" style="display:none">
    <div class="hud">
      <div class="pill">Target: <span id="target">5000</span></div>
      <div class="pill">Score: <span id="score">0</span></div>
      <div class="pill">Streak: <span id="streak">0</span></div>
      <div class="pill">Time: <span id="clock">5:00</span></div>
    </div>
    <div class="timer"><div class="bar" id="bar" style="width:100%"></div></div>
    <div class="math" id="prompt">…</div>
    <div class="grid" id="choices"></div>
    <div class="footer">
      <button class="btn ghost" id="skip">Skip</button>
      <button class="btn primary" id="next" disabled>Next</button>
    </div>
  </div>

  <div id="screen-done" class="card" style="display:none">
    <h1 id="resultTitle">Challenge Over</h1>
    <p class="sub" id="resultSub"></p>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <button class="btn primary" id="again">Play Again</button>
      <button class="btn ghost" id="csv">Export CSV</button>
      <button class="btn ghost" id="json">Export JSON</button>
    </div>
    <div class="note" id="summary"></div>
  </div>
</div>

<script>
(function(){
  const BANK = [{"prompt": "6√3 + 2√3", "correct": "8√3", "choices": ["6√3 + 2√3", "8√(2)3", "16√3"]}, {"prompt": "5√8 − 2√18", "correct": "4√2", "choices": ["4√(2)2", "8√2", "5√8 − 2√18"]}, {"prompt": "2√18 − 2√50", "correct": "-4√2", "choices": ["2√18 − 2√50", "-4√(2)2", "-8√2"]}, {"prompt": "−2√24 − 3√6 − 3√54", "correct": "-16√6", "choices": ["-32√6", "−2√24 − 3√6 − 3√54", "-16√(2)6"]}, {"prompt": "4√3 − √27 + 6√2 − 5√18", "correct": "√3 - 9√2", "choices": ["√(2)3 - 9√2", "4√3 − √27 + 6√2 − 5√18", "√3 + 9√2"]}, {"prompt": "8√27 − 9√12 − 10√24 + 5√6", "correct": "6√3 - 15√6", "choices": ["8√27 − 9√12 − 10√24 + 5√6", "6√(2)3 - 15√6", "6√3 + 15√6"]}, {"prompt": "√2 · √2", "correct": "2", "choices": ["√2 · √2", "4", "6"]}, {"prompt": "−3√6 · 5√3", "correct": "-45√2", "choices": ["−3√6 · 5√3", "-90√2", "-45√(2)2"]}, {"prompt": "2√5 · 3√8", "correct": "12√10", "choices": ["12√(2)10", "2√5 · 3√8", "24√10"]}, {"prompt": "√2(√6 + √10)", "correct": "2√3 + 2√5", "choices": ["√2(√6 + √10)", "2√3 - 2√5", "2√(2)3 + 2√5"]}, {"prompt": "√(25/16)", "correct": "5/4", "choices": ["10/4", "√(25/16)", "15/4"]}, {"prompt": "√18 / √2", "correct": "3", "choices": ["6", "√18 / √2", "9"]}, {"prompt": "√(72/18)", "correct": "2", "choices": ["√(72/18)", "4", "6"]}, {"prompt": "√(80/4)", "correct": "2√5", "choices": ["4√5", "√(80/4)", "2√(2)5"]}, {"prompt": "√108 / √3", "correct": "6", "choices": ["12", "√108 / √3", "18"]}, {"prompt": "√125 / √5", "correct": "5", "choices": ["10", "√125 / √5", "15"]}, {"prompt": "√3 / √2", "correct": "√6/2", "choices": ["√(2)6/2", "√3 / √2", "2√6/2"]}, {"prompt": "3 / √5", "correct": "(3√5)/5", "choices": ["3 / √5", "(3√(2)5)/5", "2(3√5)/5"]}, {"prompt": "√(16/3)", "correct": "(4√3)/3", "choices": ["√(16/3)", "(4√(2)3)/3", "2(4√3)/3"]}, {"prompt": "(3√5) / √7", "correct": "(3√35)/7", "choices": ["(3√(2)35)/7", "(3√5) / √7", "2(3√35)/7"]}, {"prompt": "(4√3) / √2", "correct": "2√6", "choices": ["(4√3) / √2", "2√(2)6", "4√6"]}, {"prompt": "(4√6) / (3√12)", "correct": "(2√2)/3", "choices": ["(4√6) / (3√12)", "2(2√2)/3", "(2√(2)2)/3"]}];
  const TARGET = 5000;
  const TOTAL_SECS = 300;

  const $ = s=>document.querySelector(s);
  const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

  // Sounds (web audio)
  const snd = (()=>{
    let ctx; const safe = fn=>{ try{ fn(); }catch(e){} };
    function beep(type="sine", freq=880, dur=0.12, vol=0.06){
      ctx = ctx || new (window.AudioContext||window.webkitAudioContext||function(){})();
      if(typeof ctx === 'function') return;
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = vol;
      o.connect(g); g.connect(ctx.destination); o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur); o.stop(ctx.currentTime + dur);
    }
    return {
      correct(){ safe(()=>{beep("triangle",880,.11,.06); setTimeout(()=>beep("triangle",1320,.12,.05),90)}); },
      wrong(){ safe(()=>beep("sawtooth",180,.18,.06)); },
      tick(){ safe(()=>beep("sine",880,.05,.03)); },
      win(){ safe(()=>{beep("triangle",660,.1,.06); setTimeout(()=>beep("triangle",990,.1,.06),100); setTimeout(()=>beep("triangle",1320,.12,.06),200)}) },
      end(){ safe(()=>beep("square",660,.22,.06)); }
    };
  })();

  // Confetti (no libs)
  const CF = (()=>{
    let cvs=null, ctx=null, parts=[], running=false, t0=0;
    function ensureCanvas(){
      if(cvs) return;
      cvs = document.createElement('canvas');
      cvs.id = 'confetti';
      Object.assign(cvs.style, { position:'fixed', inset:'0', pointerEvents:'none', zIndex:'9999', display:'none' });
      document.body.appendChild(cvs);
      ctx = cvs.getContext('2d');
      window.addEventListener('resize', resize);
      resize();
    }
    function resize(){
      if(!cvs) return;
      const dpr = Math.max(1, window.devicePixelRatio||1);
      cvs.width = Math.floor(window.innerWidth*dpr);
      cvs.height = Math.floor(window.innerHeight*dpr);
      cvs.style.width = window.innerWidth + 'px';
      cvs.style.height = window.innerHeight + 'px';
      if(ctx) ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    function spawn(n){
      parts = [];
      const w = window.innerWidth, h = window.innerHeight;
      for(let i=0;i<n;i++){
        parts.push({ x:Math.random()*w, y:-10-Math.random()*h*0.3, vx:-2+Math.random()*4, vy:2+Math.random()*3, g:0.05+Math.random()*0.02, s:6+Math.random()*6, r:Math.random()*Math.PI, vr:-0.15+Math.random()*0.3, hue:Math.floor(Math.random()*360) });
      }
    }
    function draw(){
      if(!running) return;
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      for(const p of parts){
        p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.r+=p.vr;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillStyle = `hsl(${p.hue},90%,60%)`; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
        ctx.restore();
        if(p.y > window.innerHeight + 40) { p.y = -20; p.vy = 2 + Math.random()*3; }
      }
      if(performance.now() - t0 < 3200){ requestAnimationFrame(draw); } else { running=false; cvs.style.display='none'; }
    }
    function go(){ ensureCanvas(); spawn(180); cvs.style.display='block'; running=true; t0=performance.now(); requestAnimationFrame(draw); }
    return { go };
  })();

  // Math render
  function m(txt){
    let s = String(txt).replace(/\^(-?\d+)/g, (_,e)=>`<sup>${e}</sup>`);
    s = s.replace(/·/g,'&middot;').replace(/−/g,'-');
    return s;
  }

  // Equivalence checker (numeric radicals)
  function toJS(expr){
    let s = String(expr).replace(/−/g,'-').replace(/\s+/g,'');
    s = s.replace(/√\(/g,'Math.sqrt(');
    s = s.replace(/\^(-?\d+)/g,'**$1');
    s = s.replace(/(\))(\d)/g,'$1*$2'); // )2 => )*2
    s = s.replace(/(\d)\(/g,'$1*(');  // 2( => 2*(
    s = s.replace(/(Math\.sqrt\([^)]*\))(\d)/g,'$1*$2'); // sqrt(... )2 -> *2
    s = s.replace(/(\d)(Math\.sqrt)/g,'$1*$2'); // 2√(...) -> 2*Math.sqrt
    s = s.replace(/(Math\.sqrt\([^)]*\))\(/g,'$1*(');
    return s;
  }
  function evalExpr(expr){
    try{ return Function(`"use strict"; return (${toJS(expr)});`)(); }catch(e){ return NaN; }
  }
  function isEquivalent(a,b){
    const va = evalExpr(a), vb = evalExpr(b);
    if(!isFinite(va) || !isFinite(vb)) return false;
    return Math.abs(va - vb) < 1e-6;
  }

  // --- Game State ---
  const S = {
    start: $("#screen-start"),
    game:  $("#screen-game"),
    done:  $("#screen-done"),
    startBtn: $("#start"),
    next: $("#next"),
    skip: $("#skip"),
    prompt: $("#prompt"),
    choices: $("#choices"),
    score: $("#score"),
    streak: $("#streak"),
    bar: $("#bar"),
    clock: $("#clock"),
    target: $("#target"),
    resultTitle: $("#resultTitle"),
    resultSub: $("#resultSub"),
    again: $("#again"),
    csv: $("#csv"),
    json: $("#json"),
    summary: $("#summary"),
    player: $("#player"),
  };

  let i=0, order=[], score=0, streak=0, tId=null, tLeft=TOTAL_SECS, history=[], current=null;

  function buildOrder(){ order = shuffle(BANK.map((q,idx)=>({ idx, ...q }))); }

  function start(){
    buildOrder(); i=0; score=0; streak=0; history=[]; tLeft = TOTAL_SECS; 
    S.target.textContent = TARGET; S.score.textContent = score; S.streak.textContent = streak;
    S.start.style.display="none"; S.done.style.display="none"; S.game.style.display="block";
    tickClock();
    tId = setInterval(()=>{ tLeft -= .1; if (Math.ceil(tLeft) <= 5 && Math.abs(tLeft - Math.round(tLeft)) < 0.06) snd.tick(); if (tLeft <= 0) { clearInterval(tId); finish(false); } tickClock(); },100);
    nextQ();
  }

  function tickClock(){
    const m = Math.max(0, Math.floor(tLeft/60)), s = Math.max(0, Math.floor(tLeft%60));
    S.clock.textContent = `${m}:${s<10?'0'+s:s}`; S.bar.style.width = (Math.max(0, tLeft/TOTAL_SECS)*100) + "%";
  }

  function nextQ(){ if (i >= order.length) buildOrder(), i=0; current = order[i++]; renderQ(current); }

  function renderQ(q){
    S.prompt.innerHTML = m(q.prompt); S.choices.innerHTML = ""; S.next.disabled = true; S.skip.disabled = false; q.renderStart = performance.now();
    const opts = shuffle([q.correct, ...q.choices]).slice(0,4);
    opts.forEach(opt=>{
      const b = document.createElement("button");
      b.className = "choice";
      b.dataset.raw = opt;
      b.innerHTML = m(opt);
      b.addEventListener("click", ()=>pick(b, q, opt, opts));
      S.choices.appendChild(b);
    });
  }

  function pick(btn, q, opt, opts){
    const ok = (opt === q.correct) || isEquivalent(opt, q.correct) || isEquivalent(opt, q.prompt);
    const t = Math.max(0, (performance.now() - q.renderStart)|0) / 1000;
    let gained = 0;
    if(ok){
      const timeBonus = Math.max(0, Math.round(300 * (1 - Math.min(1, t/10))));
      const base = 200;
      streak += 1;
      const streakBonus = Math.min(300, 50*(streak-1));
      gained = base + timeBonus + streakBonus;
      score += gained; snd.correct();
    }else{
      streak = 0; snd.wrong();
    }
    let trueIdx = -1;
    opts.forEach((o,idx)=>{ if(o===q.correct || isEquivalent(o, q.correct) || isEquivalent(o, q.prompt)) trueIdx = idx; });
    [...S.choices.children].forEach((el,idx)=>{
      if(idx===trueIdx) el.classList.add("correct");
      if(el===btn && !ok) el.classList.add("wrong");
      el.disabled = true;
    });
    S.score.textContent = score; S.streak.textContent = streak;
    S.next.disabled = false; S.skip.disabled = true;
    history.push({ prompt:q.prompt, correct:opts[trueIdx], pick:opt, ok, ms:Math.round(t*1000), gained });
    if(score >= TARGET){ clearInterval(tId); finish(true); }
  }

  function finish(won){
    S.game.style.display="none"; S.done.style.display="block";
    if(won){ S.resultTitle.textContent = "Target Reached!"; S.resultSub.textContent = `You hit ${TARGET} points!`; snd.win(); CF.go(); }
    else { S.resultTitle.textContent = "Time's Up"; S.resultSub.textContent = `Final score: ${score}`; snd.end(); }
    const right = history.filter(h=>h.ok).length;
    const total = history.length;
    const acc = total? Math.round(100*right/total):0;
    S.summary.textContent = `Answered: ${total} | Correct: ${right} (${acc}%) | Best streak: ${bestStreak()}`;
  }

  function bestStreak(){
    let best=0, cur=0;
    for(const h of history){
      if(h.ok){ cur+=1; best=Math.max(best,cur);} else {cur=0;}
    }
    return best;
  }

  S.startBtn.addEventListener("click", start);
  S.next.addEventListener("click", nextQ);
  S.skip.addEventListener("click", nextQ);
  S.again.addEventListener("click", ()=>location.reload());

  function download(data, name, type){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([data],{type}));
    a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }
  document.getElementById("csv").addEventListener("click", ()=>{
    const rows = [["Player","Target","Seconds","Score","Answered","Correct","Accuracy%","Best Streak","Prompt","Your Answer","Correct Answer","OK","Gained","Time(ms)"]];
    const acc = history.length? Math.round(100*history.filter(h=>h.ok).length/history.length):0;
    const best = bestStreak();
    history.forEach(h=>{
      rows.push([document.getElementById("player").value||"Player", TARGET, TOTAL_SECS, score, history.length, history.filter(x=>x.ok).length, acc, best, h.prompt, h.pick||"", h.correct, h.ok?"TRUE":"FALSE", h.gained, h.ms]);
    });
    const csv = rows.map(r=>r.map(v=>String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:v).join(',')).join('\n');
    download(csv, `target_score_roots_ops_packet_${Date.now()}.csv`, "text/csv");
  });
  document.getElementById("json").addEventListener("click", ()=>{
    const payload = { player:document.getElementById("player").value||"Player", target:TARGET, seconds:TOTAL_SECS, finalScore:score,
      answered:history.length, correct:history.filter(h=>h.ok).length, bestStreak:bestStreak(), results:history };
    download(JSON.stringify(payload,null,2), `target_score_roots_ops_packet_${Date.now()}.json`, "application/json");
  });
})();
</script>
</body>
</html>
