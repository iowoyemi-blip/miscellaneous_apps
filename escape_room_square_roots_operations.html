
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Escape Room â€” Square Roots Operations</title>
<style>
  :root{ --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#7c3aed; --good:#16a34a; --bad:#dc2626; --warn:#f59e0b; --ok:#22c55e; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,#0b1226,#0e1630 40%,#0d1b2a);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:auto;padding:24px}
  .card{background:rgba(17,24,39,.85);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:22px;box-shadow:0 10px 25px rgba(0,0,0,.35)}
  h1{font-size:clamp(24px,3vw,34px);margin:0 0 8px}
  .sub{color:var(--muted);margin:0 0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input{background:#0b1020;color:var(--ink);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px 12px;font-size:16px;outline:none}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 16px;font-weight:700;letter-spacing:.3px}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--ink)}
  .locks{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:14px}
  .lock{background:#0b1020;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px;cursor:pointer;transition:transform .12s, box-shadow .12s}
  .lock:hover{transform:translateY(-2px);box-shadow:0 10px 15px rgba(0,0,0,.25)}
  .lock .name{font-weight:900}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#0b1020;border:1px solid rgba(255,255,255,.12);color:var(--muted);font-weight:800;font-size:12px}
  .badge.ok{color:#86efac;border-color:rgba(34,197,94,.5)}
  .grid{display:grid;grid-template-columns:repeat(2, minmax(260px,1fr));gap:12px;margin-top:10px}
  .q{background:#0c1328;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
  .q .prompt{font-weight:800;text-align:center;margin:4px 0 10px;font-size:18px}
  .choice{display:block;width:100%;text-align:center;background:#0b1020;border:1px solid rgba(255,255,255,.08);color:var(--ink);border-radius:10px;padding:10px;font-weight:700;cursor:pointer;margin:6px 0;transition:.12s background,.12s transform}
  .choice.correct{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.5)}
  .choice.wrong{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.5)}
  .panel{margin-top:16px;display:none}
  .codebox{display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap}
  .digits{display:flex;gap:8px}
  .digit{width:44px;height:44px;border-radius:10px;border:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-weight:900;background:#0b1020}
  .open{background:rgba(34,197,94,.16);border:1px solid rgba(34,197,94,.35)}
  .math sup{font-size:.6em}
  .note{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div id="screen-start" class="card">
    <h1>Escape Room â€” Square Roots Operations</h1>
    <p class="sub">Open every lock by answering correctly. Code rule: <b>for each simplified answer, add all numeric coefficients outside radicals (ignore denominators); use the last digit of that sum</b>. (e.g., <i>2âˆš3 + 2âˆš5 â†’ 4</i>, <i>(3âˆš5)/5 â†’ 3</i>, <i>âˆš6/2 â†’ 1</i>)</p>
    <div class="row">
      <label>Player name <input id="player" placeholder="e.g., Jordan A." autocomplete="off"></label>
      <label style="display:flex;align-items:center;gap:8px"><input id="shuffle" type="checkbox" checked> Shuffle answer choices</label>
    </div>
    <button class="btn primary" id="start">Enter the Room</button>
  </div>

  <div id="screen-game" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="badge">Player: <span id="who">Player</span></div>
      <div class="badge">Locks opened: <span id="count">0</span>/<span id="totalLocks"></span></div>
      <div class="badge">Attempts: <span id="tries">0</span></div>
    </div>
    <div class="locks" id="locks"></div>

    <div id="panel" class="panel">
      <h3 id="lname" style="margin:6px 0 6px">Lock</h3>
      <div class="grid" id="grid"></div>
      <div class="codebox">
        <div class="digits" id="digits"></div>
        <button class="btn primary" id="tryOpen" disabled>Try Code</button>
        <span class="badge" id="msg"></span>
      </div>
      <p class="note">Digits update as you answer. Correct answers turn green; wrong turns red. When the code matches, the lock opens.</p>
    </div>
  </div>

  <div id="screen-done" class="card" style="display:none">
    <h1>Escaped! ðŸŽ‰</h1>
    <p class="sub">Great work, <b id="finName"></b> â€” you opened all the locks.</p>
    <div class="row">
      <div class="badge">Attempts: <span id="finTries"></span></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn primary" id="again">Play Again</button>
      <button class="btn ghost" id="csv">Export CSV</button>
      <button class="btn ghost" id="json">Export JSON</button>
    </div>
  </div>
</div>

<script>
(function(){
  const DATA = {"BANK": [{"prompt": "6âˆš3 + 2âˆš3", "correct": "8âˆš3", "choices": ["6âˆš3 + 2âˆš3", "16âˆš3", "8âˆš3"]}, {"prompt": "5âˆš8 âˆ’ 2âˆš18", "correct": "4âˆš2", "choices": ["8âˆš2", "5âˆš8 âˆ’ 2âˆš18", "4âˆš2"]}, {"prompt": "2âˆš18 âˆ’ 2âˆš50", "correct": "-4âˆš2", "choices": ["2âˆš18 âˆ’ 2âˆš50", "-8âˆš2", "-4âˆš2"]}, {"prompt": "âˆ’2âˆš24 âˆ’ 3âˆš6 âˆ’ 3âˆš54", "correct": "-16âˆš6", "choices": ["-32âˆš6", "âˆ’2âˆš24 âˆ’ 3âˆš6 âˆ’ 3âˆš54", "-16âˆš6"]}, {"prompt": "4âˆš3 âˆ’ âˆš27 + 6âˆš2 âˆ’ 5âˆš18", "correct": "âˆš3 - 9âˆš2", "choices": ["4âˆš3 âˆ’ âˆš27 + 6âˆš2 âˆ’ 5âˆš18", "âˆš3 + 9âˆš2", "âˆš3 - 9âˆš2"]}, {"prompt": "8âˆš27 âˆ’ 9âˆš12 âˆ’ 10âˆš24 + 5âˆš6", "correct": "6âˆš3 - 15âˆš6", "choices": ["8âˆš27 âˆ’ 9âˆš12 âˆ’ 10âˆš24 + 5âˆš6", "6âˆš3 + 15âˆš6", "6âˆš3 - 15âˆš6"]}, {"prompt": "âˆš2 Â· âˆš2", "correct": "2", "choices": ["âˆš2 Â· âˆš2", "4", "2"]}, {"prompt": "âˆ’3âˆš6 Â· 5âˆš3", "correct": "-45âˆš2", "choices": ["âˆ’3âˆš6 Â· 5âˆš3", "-90âˆš2", "-45âˆš2"]}, {"prompt": "2âˆš5 Â· 3âˆš8", "correct": "12âˆš10", "choices": ["2âˆš5 Â· 3âˆš8", "24âˆš10", "12âˆš10"]}, {"prompt": "âˆš2(âˆš6 + âˆš10)", "correct": "2âˆš3 + 2âˆš5", "choices": ["âˆš2(âˆš6 + âˆš10)", "2âˆš3 - 2âˆš5", "2âˆš3 + 2âˆš5"]}, {"prompt": "âˆš(25/16)", "correct": "5/4", "choices": ["10/4", "âˆš(25/16)", "5/4"]}, {"prompt": "âˆš18 / âˆš2", "correct": "3", "choices": ["6", "âˆš18 / âˆš2", "3"]}, {"prompt": "âˆš(72/18)", "correct": "2", "choices": ["âˆš(72/18)", "4", "2"]}, {"prompt": "âˆš(80/4)", "correct": "2âˆš5", "choices": ["4âˆš5", "âˆš(80/4)", "2âˆš5"]}, {"prompt": "âˆš108 / âˆš3", "correct": "6", "choices": ["12", "âˆš108 / âˆš3", "6"]}, {"prompt": "âˆš125 / âˆš5", "correct": "5", "choices": ["10", "âˆš125 / âˆš5", "5"]}, {"prompt": "âˆš3 / âˆš2", "correct": "âˆš6/2", "choices": ["âˆš3 / âˆš2", "2âˆš6/2", "âˆš6/2"]}, {"prompt": "3 / âˆš5", "correct": "(3âˆš5)/5", "choices": ["3 / âˆš5", "2(3âˆš5)/5", "(3âˆš5)/5"]}, {"prompt": "âˆš(16/3)", "correct": "(4âˆš3)/3", "choices": ["âˆš(16/3)", "2(4âˆš3)/3", "(4âˆš3)/3"]}, {"prompt": "(3âˆš5) / âˆš7", "correct": "(3âˆš35)/7", "choices": ["(3âˆš5) / âˆš7", "2(3âˆš35)/7", "(3âˆš35)/7"]}, {"prompt": "(4âˆš3) / âˆš2", "correct": "2âˆš6", "choices": ["(4âˆš3) / âˆš2", "4âˆš6", "2âˆš6"]}, {"prompt": "(4âˆš6) / (3âˆš12)", "correct": "(2âˆš2)/3", "choices": ["(4âˆš6) / (3âˆš12)", "2(2âˆš2)/3", "(2âˆš2)/3"]}], "LOCKS": [{"name": "Lock A", "indices": [0, 1, 2, 3]}, {"name": "Lock B", "indices": [4, 5, 6, 7]}, {"name": "Lock C", "indices": [8, 9, 10, 11]}, {"name": "Lock D", "indices": [12, 13, 14, 15, 16]}, {"name": "Lock E", "indices": [17, 18, 19, 20, 21]}], "TITLE": "Escape Room â€” Square Roots Operations"};

  const $ = s=>document.querySelector(s);
  const el = id=>document.getElementById(id);
  const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

  // Sounds
  const snd = (()=>{
    let ctx; const safe = fn=>{ try{ fn(); }catch(e){} };
    function beep(type="sine", freq=880, dur=0.12, vol=0.06){
      ctx = ctx || new (window.AudioContext||window.webkitAudioContext||function(){})();
      if(typeof ctx === 'function') return;
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = vol;
      o.connect(g); g.connect(ctx.destination); o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur); o.stop(ctx.currentTime + dur);
    }
    return {
      correct(){ safe(()=>{beep("triangle",880,.11,.06); setTimeout(()=>beep("triangle",1320,.12,.05),90)}); },
      wrong(){ safe(()=>beep("sawtooth",180,.18,.06)); },
      open(){ safe(()=>{beep("triangle",660,.1,.06); setTimeout(()=>beep("triangle",990,.1,.06),100); setTimeout(()=>beep("triangle",1320,.12,.06),200)}); },
      end(){ safe(()=>beep("square",660,.22,.06)); }
    };
  })();

  // Render math (^exp and unicode minus)
  function m(txt){
    let s = String(txt).replace(/\^(\-?\d+)/g, (_,e)=>`<sup>${e}</sup>`);
    s = s.replace(/âˆ’/g,'&minus;').replace(/Â·/g,'&middot;');
    return s;
  }

  // Compute digit: sum of absolute numeric coefficients in numerator (outside radicals), last digit
  function digitFromAnswer(ans){
    let s = String(ans).replace(/\s+/g,'').replace(/âˆ’/g,'-');
    // Split into terms by + or - (keep signs)
    const parts = s.match(/([+-]?[^+-]+)/g) || [s];
    let sum = 0;
    for(let part of parts){
      if(!part) continue;
      let sign = 1;
      if(part[0]==='+'){ part = part.slice(1); }
      else if(part[0]==='-'){ sign = -1; part = part.slice(1); }
      const numer = part.split('/')[0]; // ignore denominator
      // implicit 1 if starts with âˆš or (âˆš
      if(/^\(?âˆš/.test(numer)){ sum += 1; continue; }
      const m = numer.match(/^\(?([0-9]+)/);
      if(m){ sum += Math.abs(parseInt(m[1],10)); }
      else { sum += 1; }
    }
    const str = String(sum);
    return str[str.length-1];
  }

  const S = {
    start: el('screen-start'),
    game: el('screen-game'),
    done: el('screen-done'),
    player: el('player'),
    shuffle: el('shuffle'),
    who: el('who'),
    count: el('count'),
    totalLocks: el('totalLocks'),
    tries: el('tries'),
    locks: el('locks'),
    panel: el('panel'),
    lname: el('lname'),
    grid: el('grid'),
    digits: el('digits'),
    tryOpen: el('tryOpen'),
    msg: el('msg'),
    finName: el('finName'),
    finTries: el('finTries'),
  };

  let tries = 0;
  let opened = new Array(DATA.LOCKS.length).fill(false);
  let currentLock = 0;
  let answers = {}; // lockIndex -> {qid->choice}
  let targets = DATA.LOCKS.map(L => L.indices.map(id => digitFromAnswer(DATA.BANK[id].correct)).join(''));

  el('start').addEventListener('click', ()=>{
    S.start.style.display='none'; S.game.style.display='block';
    S.who.textContent = S.player.value || 'Player';
    S.totalLocks.textContent = DATA.LOCKS.length;
    renderLocks();
    openLock(0);
  });

  el('again').addEventListener('click', ()=>location.reload());

  function renderLocks(){
    S.locks.innerHTML = '';
    DATA.LOCKS.forEach((L, idx)=>{
      const need = L.indices.length;
      const card = document.createElement('div');
      card.className = 'lock' + (opened[idx]?' open':'');
      card.innerHTML = `
        <div class="name">${L.name}</div>
        <div class="badge ${opened[idx]?'ok':''}">${opened[idx]?'Opened':'Locked'}</div>
        <div class="note">Target: ${need} digit${need>1?'s':''}</div>`;
      card.addEventListener('click', ()=> openLock(idx));
      S.locks.appendChild(card);
    });
    S.count.textContent = opened.filter(Boolean).length;
  }

  function buildDigitsView(code, need){
    S.digits.innerHTML = '';
    const chars = code.split('');
    for(let i=0;i<need;i++){
      const d = document.createElement('div');
      d.className = 'digit';
      d.textContent = chars[i] || 'â€¢';
      S.digits.appendChild(d);
    }
  }

  function openLock(idx){
    currentLock = idx;
    const L = DATA.LOCKS[idx];
    S.panel.style.display = 'block';
    S.lname.textContent = `${L.name} â€” answer all ${L.indices.length}`;
    S.grid.innerHTML = '';
    S.msg.textContent = '';
    const qids = L.indices;
    const show = qids.map(id => Object.assign({id}, DATA.BANK[id]));
    show.forEach((q)=>{
      const card = document.createElement('div'); card.className='q';
      const opts = (S.shuffle.checked ? shuffle([q.correct, ...q.choices]) : [q.correct, ...q.choices]).slice(0,4);
      const content = `
        <div class="prompt math">${m(q.prompt)}</div>
        <div class="choices"></div>`;
      card.innerHTML = content;
      const choicesDiv = card.querySelector('.choices');
      opts.forEach(opt=>{
        const b = document.createElement('button');
        b.className = 'choice'; b.dataset.raw = opt; b.innerHTML = m(opt);
        b.addEventListener('click', ()=> pick(b, q, opt));
        choicesDiv.appendChild(b);
      });
      S.grid.appendChild(card);
    });
    updateDigits();
    S.tryOpen.disabled = true;
  }

  function pick(btn, q, opt){
    const correct = (opt === q.correct);
    btn.classList.remove('wrong','correct');
    if(correct){ btn.classList.add('correct'); snd.correct(); }
    else { btn.classList.add('wrong'); snd.wrong(); }
    if(correct){
      [...btn.parentElement.children].forEach(el=>{ el.disabled = true; if(el!==btn) el.classList.add('wrong'); });
      answers[currentLock] = answers[currentLock] || {};
      answers[currentLock][q.id] = opt;
      updateDigits();
      checkReady();
    }else{
      tries += 1; S.tries.textContent = String(tries);
    }
  }

  function updateDigits(){
    const L = DATA.LOCKS[currentLock];
    const need = L.indices.length;
    const code = L.indices.map(id => {
      const chosen = answers[currentLock] && answers[currentLock][id];
      return chosen ? digitFromAnswer(chosen) : '';
    }).join('');
    buildDigitsView(code, need);
  }

  function checkReady(){
    const L = DATA.LOCKS[currentLock];
    const haveAll = L.indices.every(id => answers[currentLock] && answers[currentLock][id]);
    S.tryOpen.disabled = !haveAll;
  }

  S.tryOpen.addEventListener('click', ()=>{
    const L = DATA.LOCKS[currentLock];
    const need = L.indices.length;
    const code = L.indices.map(id => digitFromAnswer(answers[currentLock][id])).join('');
    const target = targets[currentLock];
    if(code === target){
      opened[currentLock] = true;
      renderLocks();
      S.msg.textContent = "Unlocked!";
      S.msg.classList.add('ok');
      snd.open();
      const next = opened.indexOf(false);
      if(next === -1){
        S.game.style.display = 'none'; S.done.style.display = 'block'; snd.end();
        el('finName').textContent = S.player.value || 'Player';
        el('finTries').textContent = String(tries);
      }else{
        openLock(next);
      }
    }else{
      tries += 1; S.tries.textContent = String(tries);
      S.msg.textContent = "Wrong code â€” keep checking.";
      S.msg.classList.remove('ok');
      snd.wrong();
    }
  });

  function download(data, name, type){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([data],{type}));
    a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }
  function exportCSV(){
    const rows = [["Player","Attempts","Locks Opened","Lock","Code Entered","Correct Code"]];
    DATA.LOCKS.forEach((L, idx)=>{
      const need = L.indices.length;
      const code = (answers[idx]? L.indices.map(id => digitFromAnswer(answers[idx][id]||"")).join('') : "");
      rows.push([S.player.value||"Player", tries, opened.filter(Boolean).length, L.name, code, targets[idx]]);
    });
    const csv = rows.map(r=>r.map(v=>String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:v).join(',')).join('\n');
    download(csv, `escape_roots_operations_results_${Date.now()}.csv`, "text/csv");
  }
  function exportJSON(){
    const payload = {
      player: S.player.value || "Player",
      attempts: tries,
      opened: opened,
      locks: DATA.LOCKS.map((L,idx)=>({ name:L.name, entered: (answers[idx]? L.indices.map(id => digitFromAnswer(answers[idx][id]||"")).join('') : null), target: targets[idx] }))
    };
    download(JSON.stringify(payload,null,2), `escape_roots_operations_results_${Date.now()}.json`, "application/json");
  }
  document.getElementById('csv').addEventListener('click', exportCSV);
  document.getElementById('json').addEventListener('click', exportJSON);
})();
</script>
</body>
</html>
